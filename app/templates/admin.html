{% extends "base.html" %}
{% block content %}
<div class="container py-5 px-3 px-md-4">
  <h1 class="display-4 fw-bold hero-title">Administration</h1>
  <p class="lead text-muted mb-4">Manage users and groups.</p>

  <!-- USERS TABLE -->
  <div class="mb-5">
    <h3>Users</h3>
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Verified</th>
            <th>Runs</th>
            <th>Groups</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td>{{ user.username }}</td>
            <td>
              <div class="text-truncate" style="max-width: 180px;" title="{{ user.email }}">
                {{ user.email }}
              </div>
            </td>
            <td>{{ user.role.value }}</td>
            <td>{{ 'Yes' if user.is_verified else 'No' }}</td>
            <td>{{ user_stats[user.id].num_runs }}</td>
            <td>{{ user_stats[user.id].num_groups }}</td>
            <td class="text-end">
              <div class="d-grid gap-1 d-md-flex justify-content-md-end">
                <button class="btn btn-sm btn-soft" data-bs-toggle="modal" data-bs-target="#editUserModal"
                        onclick="prepareEditUser({{ user.id }}, '{{ user.username }}')">Edit</button>
                {% if user.role.name == 'ADMIN' and user.id != current_user.id %}
                  <form method="POST" action="{{ url_for('admin_demote_user', user_id=user.id) }}" class="d-inline">
                    <button class="btn btn-sm btn-outline-secondary">Remove Admin</button>
                  </form>
                {% elif user.role.name != 'ADMIN' %}
                  <form method="POST" action="{{ url_for('admin_promote_user', user_id=user.id) }}" class="d-inline">
                    <button class="btn btn-sm btn-outline-warning">Make Admin</button>
                  </form>
                {% endif %}
                {% if not user.is_verified %}
                  <form method="POST" action="{{ url_for('admin_verify_user', user_id=user.id) }}" class="d-inline">
                    <button class="btn btn-sm btn-outline-success">Verify</button>
                  </form>
                {% endif %}
                <button class="btn btn-sm btn-outline-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteUserModal"
                        onclick="prepareDeleteUser({{ user.id }}, '{{ user.username }}')">Delete</button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- GROUPS TABLE -->
  <div>
    <h3>Groups</h3>
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>Name</th>
            <th>Description</th>
            <th>Users</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for group in groups %}
          <tr>
            <td>{{ group.name }}</td>
            <td>
              <div class="text-truncate" style="max-width: 200px;" title="{{ group.description }}">
                {{ group.description[:60] }}{% if group.description|length > 60 %}â€¦{% endif %}
              </div>
            </td>
            <td>{{ group_stats[group.id].num_users }}</td>
            <td class="text-end">
              <div class="d-grid gap-1 d-md-flex justify-content-md-end">
                <button class="btn btn-sm btn-soft" data-bs-toggle="modal" data-bs-target="#editGroupModal"
                        onclick="prepareEditGroup({{ group.id }}, '{{ group.name }}', `{{ group.description|e }}`)">Edit</button>

                <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#addUserToGroupModal"
                        onclick="document.getElementById('addUserGroupId').value = '{{ group.id }}';">Add User</button>

                <button class="btn btn-sm btn-outline-warning"
                        data-bs-toggle="modal"
                        data-bs-target="#removeUserFromGroupModal{{ group.id }}">
                  Remove User
                </button>

                <button class="btn btn-sm btn-outline-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteGroupModal"
                        onclick="prepareDeleteGroup({{ group.id }}, '{{ group.name }}')">Delete</button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
